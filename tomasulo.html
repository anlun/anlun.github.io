<html>
  <body>
    <script>
      var program =
        [ {tag : "ADD", res : "%R3", op1 :  "$1", op2 : "$2" },
          {tag : "SUB", res : "%R2", op1 : "%R3", op2 : "$4" },
          {tag : "MUL", res : "%R0", op1 : "%R2", op2 : "%R3"},
          {tag : "ST" , res : "#0" , op1 : "%R0", op2 : ""   },
          {tag : "LD" , res : "%R4", op1 : "#0" , op2 : ""   } ];
      
      var regfile = [0, 0, 0, 0, 0, 0];
      var memory  = [0, 0, 0, 0, 0, 0];
      var ip = 0;
      var cycle = 0;
      
      var rtable =
        [ { busy : false, tag : null, val1 : null, val2 : null, q1 : null, q2 : null, disp : false},
          { busy : false, tag : null, val1 : null, val2 : null, q1 : null, q2 : null, disp : false},
          { busy : false, tag : null, val1 : null, val2 : null, q1 : null, q2 : null, disp : false} ];
      
      function step() {
        cycle++;
        if (ip < program.length) {
          executeInstr();
          if (addToRTable()) { ip++; }
        }
        document.body.innerHTML = "";
        printWorld();
      }
      
      function regSyntaxToN(regStr) {
        return parseInt(regStr.substring(2));
      }

      function addrSyntaxToN(addrStr) {
        return parseInt(addrStr.substring(1));
      }
          
      function getValue(op) {
        switch (op[0]) {
          case "$": return { val : parseInt(op.substring(1)), rentryN : null };
          case "%": return { val : regfile[regSyntaxToN(op)], rentryN : null  };
          case "#": return { val : memory[op.substring(1)]  , rentryN : null  };
        }
        return { val : null, rentryN : null };
      }
      
      function executeInstr() {
        var instr = program[ip];
        switch (instr.tag) {
          case "ADD":
            var lval = getValue(instr.op1).val;
            var rval = getValue(instr.op2).val;
            regfile[regSyntaxToN(instr.res)] = lval + rval;
            break;
          case "SUB":
            var lval = getValue(instr.op1).val;
            var rval = getValue(instr.op2).val;
            regfile[regSyntaxToN(instr.res)] = lval - rval;
            break;
          case "MUL":
            var lval = getValue(instr.op1).val;
            var rval = getValue(instr.op2).val;
            regfile[regSyntaxToN(instr.res)] = lval * rval;
            break;
          case "LD":
            var lval = getValue(instr.op1).val;
            regfile[regSyntaxToN(instr.res)] = lval;
            break;
          case "ST":
            var lval = getValue(instr.op1).val;
            memory[addrSyntaxToN(instr.res)] = lval;
            break;
        }
      }
                 
      function findFreeREntry() {
        for (rentryN in rtable) {
          var rentry = rtable[rentryN];
          if (!rentry.busy) { return rentryN; }
        }
        return -1;
      }
      
      function addToRTable() {
        var instr = program[ip];
        var rentryN = findFreeREntry();
        console.log(rentryN);
        if (rentryN < 0) { return false; }
        var rentry = rtable[rentryN];
        rentry.busy = true;
        rentry.tag = instr.tag;
        var lval = getValue(instr.op1);
        if (lval.val != null) {
          rentry.val1 = lval.val;
          rentry.q1   = null;
        } else {
          rentry.val1 = null;
          rentry.q1 = lval.rentryN;
        }
        var rval = getValue(instr.op2);
        if (rval.val != null) {
          rentry.val2 = rval.val;
          rentry.q2   = null;
        } else {
          rentry.val2 = null;
          rentry.q2 = rval.rentryN;
        }
        
        return true;
      }

      function printRTable() {
        document.writeln("Reservation Table <table border=\"1\">");
        document.writeln("<tr bgcolor=\"#FFEEAD\"> <td> IP </td>");
        for (var property in rtable[0]) {
          document.writeln("<td>" + property + "</td>");
        }
        document.writeln("</tr>");

        for (var rentryN in rtable) {
          var rentry = rtable[rentryN];
          document.writeln("<tr> <td> RS" + rentryN + " </td>");
          for (var property in rentry) {
            var pval = rentry[property];
            if (pval == null) {
              pval = "⊥";
            }
            document.writeln("<td>" + pval + "</td>");
          }
          document.writeln("</tr>");
        }
        document.writeln("</table>");
      }
      
      function printRegfile() {
        document.writeln("RegFile <table border=\"1\">");
        document.writeln("<tr bgcolor=\"#FFBBBB\">");
        document.writeln("<td> reg </td> <td> value </td> </tr>");

        for (var regN in regfile) {
          document.writeln("<tr> <td> R" + regN + "</td>");
          document.writeln("<td>" + regfile[regN] + "</td> </tr>");
        }
        document.writeln("</table>");
      }

      function printMemory() {
        document.writeln("Memory <table border=\"1\">");
        document.writeln("<tr bgcolor=\"#BBFFBB\">");
        document.writeln("<td> addr </td> <td> value </td> </tr>");

        for (var addr in memory) {
          document.writeln("<tr> <td> #" + addr + "</td>");
          document.writeln("<td>" + memory[addr] + "</td> </tr>");
        }
        document.writeln("</table>");
      }
      
      function printProgram() {
        document.writeln("Program <table border=\"1\">");
        document.writeln("<tr bgcolor=\"#BBBBFF\"> <td> IP </td>");
        for (var property in program[0]) {
          document.writeln("<td>" + property + "</td>");
        }
        document.writeln("</tr>");

        for (var instrN in program) {
          var instr = program[instrN];
          document.writeln("<tr> <td>");
          if (instrN == ip) {
            document.writeln("→");
          }
          document.writeln("</td>");
          for (var property in instr) {
            document.writeln("<td>" + instr[property] + "</td>");
          }
          document.writeln("</tr>");
        }
        document.writeln("</table>");
      }
      
      function printWorld() {
        document.writeln("<h3> Cycle: " + cycle + "</h3>");
        document.writeln("<table> <tr> <td valign=\"top\">");
        printProgram();
        document.writeln("</td> <td valign=\"top\">");
        printRegfile();
        document.writeln("</td> <td valign=\"top\">");
        printMemory();
        document.writeln("</td> </tr> </table>");
        printRTable();

        document.writeln("<br />");
        document.writeln(
          "<input type=\"button\" id=\"step-button\" value=\"Step\">");
        var stepButton = document.getElementById("step-button") ;
        stepButton.onclick = step;
      }
      printWorld();
    </script>

  </body>
</html>
